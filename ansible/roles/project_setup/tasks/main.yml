---
# Project setup role
# Clones/updates project and installs dependencies

- name: Check if project directory exists
  stat:
    path: "{{ project_dir }}"
  register: project_dir_stat

- name: Check if it's a git repository
  stat:
    path: "{{ project_dir }}/.git"
  register: git_dir_stat

- name: Remove existing directory if not a git repo
  file:
    path: "{{ project_dir }}"
    state: absent
  when: project_dir_stat.stat.exists and not git_dir_stat.stat.exists

- name: Clone or update HSI compression repository
  git:
    repo: "{{ git_repo | default('https://github.com/yourusername/hsi-compression.git') }}"
    dest: "{{ project_dir }}"
    version: "{{ git_branch | default('master') }}"
    update: yes
  register: git_result
  changed_when: git_result.changed

- name: Display git clone/update result
  debug:
    msg: "Repository {{ 'cloned' if git_result.changed else 'already up to date' }}"

- name: Install PyTorch with CUDA 12.1 wheels
  pip:
    name:
      - torch
      - torchvision
    extra_args: "--index-url https://download.pytorch.org/whl/cu121"
    virtualenv: "{{ venv_dir }}"
    virtualenv_python: python3
  async: 1800
  poll: 60
  register: pytorch_install

- name: Install build dependencies (ninja, packaging)
  pip:
    name:
      - ninja
      - packaging
    virtualenv: "{{ venv_dir }}"
    virtualenv_python: python3
  ignore_errors: yes
  register: build_deps

- name: Install mamba-ssm without build isolation
  pip:
    name: mamba-ssm
    extra_args: "--no-build-isolation"
    virtualenv: "{{ venv_dir }}"
    virtualenv_python: python3
  ignore_errors: yes
  register: mamba_install

- name: Verify mamba-ssm installation
  shell: |
    source {{ venv_dir }}/bin/activate
    python -c "from mamba_ssm import Mamba; print('mamba-ssm installed successfully')"
  args:
    executable: /bin/bash
  register: mamba_verify
  changed_when: false
  ignore_errors: yes

- name: Install project dependencies from pyproject.toml (core only)
  shell: |
    . {{ venv_dir }}/bin/activate
    pip install --upgrade pip setuptools wheel
    # Install core package first (without optional dependencies)
    pip install .
  args:
    chdir: "{{ project_dir }}"
    executable: /bin/bash
  register: pip_install
  changed_when: "'Successfully installed' in pip_install.stdout or 'already satisfied' in pip_install.stdout"

- name: Verify installation - check core package is installed
  shell: |
    . {{ venv_dir }}/bin/activate
    pip show hsi-compression
  args:
    executable: /bin/bash
  register: package_info
  changed_when: false
  ignore_errors: yes

- name: Create required directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - "{{ checkpoint_dir }}"
    - "{{ logs_dir }}"
    - "{{ results_dir }}"
    - "{{ dataset_path }}"

- name: Create activation script for convenience
  copy:
    dest: "{{ project_dir }}/activate.sh"
    content: |
      #!/bin/bash
      # Source this script to activate the virtual environment
      source {{ venv_dir }}/bin/activate
      cd {{ project_dir }}
      echo "Virtual environment activated"
      echo "Project directory: $(pwd)"
      echo "Python: $(python --version)"
    mode: '0755'

- name: Create helper scripts directory
  file:
    path: "{{ project_dir }}/scripts"
    state: directory

- name: Create training wrapper script
  copy:
    dest: "{{ project_dir }}/scripts/train.sh"
    content: |
      #!/bin/bash
      set -e
      
      source {{ venv_dir }}/bin/activate
      cd {{ project_dir }}
      
      # Parse arguments
      CONFIG="${1:-hsi_compression/configs/models/tcn_lossless.yaml}"
      EPOCHS="${2:-100}"
      
      echo "Starting training..."
      echo "Config: $CONFIG"
      echo "Epochs: $EPOCHS"
      echo "Checkpoint dir: {{ checkpoint_dir }}"
      
      python train.py \
        --config "$CONFIG" \
        --overrides \
          data.root_dir={{ dataset_path }} \
          training.epochs=$EPOCHS \
          logging.checkpoint_dir={{ checkpoint_dir }} \
          logging.wandb_enabled={{ wandb_enabled | lower }}
    mode: '0755'

- name: Create evaluation wrapper script
  copy:
    dest: "{{ project_dir }}/scripts/evaluate.sh"
    content: |
      #!/bin/bash
      set -e
      
      source {{ venv_dir }}/bin/activate
      cd {{ project_dir }}
      
      # Parse arguments
      CONFIG="${1:-hsi_compression/configs/models/tcn_lossless.yaml}"
      CHECKPOINT="${2:-{{ checkpoint_dir }}/best_val_loss.pt}"
      
      echo "Starting evaluation..."
      echo "Config: $CONFIG"
      echo "Checkpoint: $CHECKPOINT"
      
      python evaluate.py \
        --config "$CONFIG" \
        --checkpoint "$CHECKPOINT" \
        --overrides \
          data.root_dir={{ dataset_path }}
    mode: '0755'

- name: Display project setup completion
  debug:
    msg: |
      Project setup completed!
      Project directory: {{ project_dir }}
      Virtual environment: {{ venv_dir }}
      Checkpoint directory: {{ checkpoint_dir }}
      Logs directory: {{ logs_dir }}
      Dataset path: {{ dataset_path }}
      
      Helper scripts created:
      - {{ project_dir }}/activate.sh (activate environment)
      - {{ project_dir }}/scripts/train.sh (training)
      - {{ project_dir }}/scripts/evaluate.sh (evaluation)
