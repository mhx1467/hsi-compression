---
# Python setup role
# Installs Python and creates virtual environment

- name: Install Python and development tools
  apt:
    name:
      - python{{ python_version }}
      - python{{ python_version }}-dev
      - python{{ python_version }}-venv
      - python3-pip
    state: present
  become: yes
  when: ansible_os_family == "Debian"

- name: Set Python{{ python_version }} as default (if {{ python_version }} != 3)
  alternatives:
    name: python
    path: /usr/bin/python{{ python_version }}
    link: /usr/bin/python
  become: yes
  when: python_version != "3"
  ignore_errors: yes

- name: Check if project directory exists
  stat:
    path: "{{ project_dir }}"
  register: project_path

- name: Create project directory
  file:
    path: "{{ project_dir }}"
    state: directory
    mode: '0755'
  become: yes
  when: not project_path.stat.exists

- name: Change project directory ownership
  file:
    path: "{{ project_dir }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: yes
  become: yes

- name: Check if virtual environment exists
  stat:
    path: "{{ venv_dir }}"
  register: venv_path

- name: Create Python virtual environment
  shell: |
    python{{ python_version }} -m venv {{ venv_dir }}
  when: not venv_path.stat.exists
  changed_when: true

- name: Upgrade pip in virtual environment
  pip:
    name:
      - pip
      - wheel
      - setuptools
    state: latest
    virtualenv: "{{ venv_dir }}"
    virtualenv_python: python{{ python_version }}

- name: Display Python environment info
  shell: |
    source {{ venv_dir }}/bin/activate
    python --version
    pip --version
  register: python_info
  changed_when: false

- name: Show Python version
  debug:
    msg: "{{ python_info.stdout }}"
