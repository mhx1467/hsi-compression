---
# Python setup role
# Installs Python and creates virtual environment

- name: Check available Python versions
  shell: |
    apt-cache search python3 | grep "^python3\.[0-9]" | awk '{print $1}' | head -10
  register: available_pythons
  changed_when: false
  become: yes

- name: Display available Python versions
  debug:
    msg: "Available Python versions: {{ available_pythons.stdout_lines }}"

- name: Use system Python3 if specific version not available
  set_fact:
    python_to_install: "{{ python_version | default('3') }}"
  when: python_version is defined

- name: Install Python and development tools
  apt:
    name:
      - python3
      - python3-dev
      - python3-venv
      - python3-pip
    state: present
    update_cache: yes
  become: yes
  when: ansible_os_family == "Debian"

- name: Check installed Python version
  shell: |
    python3 --version 2>&1 | awk '{print $2}'
  register: installed_python
  changed_when: false

- name: Display installed Python version
  debug:
    msg: "Installed Python: {{ installed_python.stdout }}"

- name: Check if project directory exists
  stat:
    path: "{{ project_dir }}"
  register: project_path

- name: Create project directory
  file:
    path: "{{ project_dir }}"
    state: directory
    mode: '0755'
  become: yes
  when: not project_path.stat.exists

- name: Change project directory ownership
  file:
    path: "{{ project_dir }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: yes
  become: yes

- name: Check if virtual environment exists
  stat:
    path: "{{ venv_dir }}"
  register: venv_path

- name: Create Python virtual environment
  shell: |
    python3 -m venv {{ venv_dir }}
  when: not venv_path.stat.exists
  changed_when: true

- name: Upgrade pip in virtual environment
  pip:
    name:
      - pip
      - wheel
      - setuptools
    state: latest
    virtualenv: "{{ venv_dir }}"
    virtualenv_python: python3

- name: Display Python environment info
  shell: |
    source {{ venv_dir }}/bin/activate
    python --version
    pip --version
  register: python_info
  changed_when: false

- name: Show Python version
  debug:
    msg: "{{ python_info.stdout }}"
