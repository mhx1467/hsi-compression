---
# System setup role for GPU training
# Simplified version: assumes CUDA is already installed
# Only handles basic system dependencies

- name: Wait for unattended-upgrade to finish
  shell: |
    # Wait up to 5 minutes for unattended-upgrade to complete
    for i in {1..30}; do
      if ! pgrep -x unattended-upgr > /dev/null; then
        echo "unattended-upgrade finished"
        exit 0
      fi
      echo "Waiting for unattended-upgrade... ($i/30)"
      sleep 10
    done
    echo "WARNING: unattended-upgrade still running after 5 minutes, continuing anyway"
    exit 0
  become: yes
  changed_when: false
  ignore_errors: yes

- name: Update apt cache
  apt:
    update_cache: yes
  become: yes
  ignore_errors: yes

- name: Install system dependencies
  apt:
    name:
      - build-essential
      - git
      - wget
      - curl
      - libssl-dev
      - libffi-dev
      - python3-dev
      - python3-pip
      - pkg-config
      - apt-transport-https
    state: present
  become: yes
  ignore_errors: yes

- name: Check CUDA is available
  shell: |
    if command -v nvcc &> /dev/null; then
      CUDA_VERSION=$(nvcc --version | grep "release" | grep -oP '\d+\.\d+')
      echo "CUDA_FOUND: $CUDA_VERSION"
    else
      echo "CUDA_NOT_FOUND"
    fi
  register: cuda_check
  changed_when: false
  ignore_errors: yes

- name: Display CUDA status
  debug:
    msg: "{{ cuda_check.stdout }}"

- name: Fail if CUDA not available
  fail:
    msg: |
      CUDA is not installed or not in PATH.
      Please ensure CUDA 11.6+ is installed before running this playbook.
      Install CUDA manually or contact your system administrator.
  when: "'CUDA_NOT_FOUND' in cuda_check.stdout"
