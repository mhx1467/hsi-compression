---
# Playbook: setup.yml
# Sets up remote GPU machine with all dependencies and project
# Usage: ansible-playbook setup.yml -i inventory.ini -l gpu_servers

- name: Setup HSI Compression Framework on Remote GPU Machine
  hosts: "{{ target_hosts | default('gpu_servers') }}"
  gather_facts: yes
  
  vars_prompt:
    - name: git_repo
      prompt: "Git repository URL (leave blank for default)"
      default: "https://github.com/yourusername/hsi-compression.git"
      private: no
    
    - name: git_branch
      prompt: "Git branch (default: main)"
      default: "main"
      private: no

  tasks:
    - name: Display setup information
      debug:
        msg: |
          ============================================
          HSI Compression Framework Setup
          ============================================
          
          Target hosts: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Python: {{ python_version }}
          Enable CUDA: {{ enable_cuda }}
          
          Git repo: {{ git_repo }}
          Git branch: {{ git_branch }}
          ============================================

    - name: Include system setup role
      include_role:
        name: system_setup
      vars:
        cuda_version: "{{ cuda_version }}"

    - name: Include Python setup role
      include_role:
        name: python_setup

    - name: Include project setup role
      include_role:
        name: project_setup
      vars:
        git_repo: "{{ git_repo }}"
        git_branch: "{{ git_branch }}"

    - name: Setup completed
      debug:
        msg: |
          ============================================
          Setup Completed Successfully!
          ============================================
          
          Project location: {{ project_dir }}
          Virtual environment: {{ venv_dir }}
          Checkpoint directory: {{ checkpoint_dir }}
          
          Next steps:
          
          1. Pull dataset:
             ansible-playbook dataset.yml -i inventory.ini -l {{ inventory_hostname }}
          
          2. Run training:
             ansible-playbook train.yml -i inventory.ini -l {{ inventory_hostname }} \
               -e "model_name=tcn_lossless" \
               -e "training_epochs=100"
          
          3. Evaluate model:
             ansible-playbook evaluate.yml -i inventory.ini -l {{ inventory_hostname }} \
               -e "checkpoint_path={{ checkpoint_dir }}/best_val_loss.pt"
          
          4. Or manually SSH to machine and run:
             ssh {{ ansible_user }}@{{ ansible_host }}
             source {{ project_dir }}/activate.sh
             python train.py --config hsi_compression/configs/models/tcn_lossless.yaml
